package com.geemi.facelibrary.utils;

import android.annotation.SuppressLint;
import android.util.Log;

import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;

public class SipClientDemo {
//    public final String SERVICE_IP = "39.107.190.158";
    //http://39.107.190.158:9786/hls/唯一ID.m3u8
    public final String SERVICE_IP = "39.107.190.158";
    public final int SERVICE_PORT = 9786;

    public final char END_CHAR
= '#';

    // 1. ??????????????? &
    // 5. ???????????????(1. ?豸???rtmp?????(mp3??aac??????) 2. ??????????????????????rtmpЭ?????????)
    public void play(String deviceSN, String url) {
        String json_content = "{\"cmd\":\"PLAYOFF\",\"filelist\":[\"" +
                url +
                "\"],\"snlist\":[\""
                + deviceSN + "\"],\"taskid\":1005}";
        sendAndReceive(SERVICE_IP, SERVICE_PORT, json_content);
    }

    // 2. ??????????????
    public void stop(String deviceSN) {
        String json_content = "{\"cmd\":\"FORCESTOP\",\"snlist\":[\""
                + deviceSN + "\"]}";
        sendAndReceive(SERVICE_IP, SERVICE_PORT, json_content);
    }

    // 4. ????豸????? &
    // ???????????????(???????1. ????????????????? 2. ????????ò???豸?????)
    public void queryDeviceStatus() {
        String json_content = "{\"mode\":1001}";
        sendAndReceive(SERVICE_IP, SERVICE_PORT, json_content);
    }

    // 6. ?????????????
    public void changeVolume(String deviceSN, int volumn) {
        String json_content = "{\"mode\":1003,\"vol\":" + volumn + ",\"sn\":\""
                + deviceSN + "\"}";
        sendAndReceive(SERVICE_IP, SERVICE_PORT, json_content);
    }

    @SuppressLint("NewApi")
    public String sendAndReceive(String ip, int port, String msg) {
        // ???????????????????????????????????????????????????????????
        // msg = msg + END_CHAR;
        StringBuilder receiveMsg = new StringBuilder();
        Log.e("=========", "socket准备lianjie");
        Log.e("=========", "msg == " + msg);
        // ?????????????????????????
        try (Socket client = new Socket(ip, port)) {
            // ?????????д???????????????
            if (client.isConnected()) {
                Log.e("=========", "socket已经链接");
            } else {
                Log.e("=========", "socket链接失败");
            }
            OutputStream out = client.getOutputStream();
            out.write(msg.getBytes());
//			out.flush();

            // ?????????н??????????????????????????
            InputStream in = client.getInputStream();
            for (int c = in.read(); c != END_CHAR; c = in.read()) {
                if (c == -1)
                    break;
                receiveMsg.append((char) c);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return receiveMsg.toString();
    }
}